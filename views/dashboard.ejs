<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .drop-zone {
        border: 2px dashed #6c757d;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        color: #6c757d;
        transition: background-color 0.2s ease-in-out;
      }
      .drop-zone.dragover {
        background-color: #e9ecef;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">File Summarizer</a>
        <form id="logoutForm" class="d-flex">
          <button type="submit" class="btn btn-light btn-sm">Logout</button>
        </form>
      </div>
    </nav>

    <div class="container my-4">
      <h1 class="mb-4">Welcome, <%= user.name %>!</h1>

      <!-- File Upload -->
      <div class="card mb-4">
        <div class="card-body">
          <form
            id="uploadForm"
            action="/api/files/upload"
            method="POST"
            enctype="multipart/form-data"
          >
            <div class="drop-zone" id="dropZone">
              <p>Drag & drop your file here or click to select</p>
              <input
                type="file"
                name="file"
                accept=".pdf,.png,.jpg,.jpeg"
                hidden
                required
              />
            </div>
            <button type="submit" class="btn btn-success mt-3">Upload</button>
          </form>
        </div>
      </div>

      <!-- File List -->
      <h2>Your Files</h2>
      <ul class="list-group">
        <% files.forEach(file => { %>
        <li
          class="list-group-item d-flex justify-content-between align-items-center"
        >
          <span>
            <!-- Show just file name -->
            <a href="<%= file.url %>" target="_blank">
              <%= file.url.split('/').pop() %>
            </a>
          </span>
          <div>
            <!-- Dropdown for summary length -->
            <form
              action="/files/summary/<%= file._id %>"
              method="POST"
              class="d-flex align-items-center"
            >
              <select name="length" class="form-select form-select-sm me-2">
                <option value="short">Short</option>
                <option value="medium">Medium</option>
                <option value="long">Long</option>
              </select>
              <button type="submit" class="btn btn-outline-primary btn-sm">
                Get Summary
              </button>
            </form>
          </div>
        </li>
        <% }) %>
      </ul>
    </div>

    <script>
      const dropZone = document.getElementById("dropZone");
      const fileInput = dropZone.querySelector("input");
      const uploadForm = document.getElementById("uploadForm");
      const logoutForm = document.getElementById("logoutForm");

      // drag & drop handling
      dropZone.addEventListener("click", () => fileInput.click());
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
      });
      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("dragover");
      });
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
        }
      });

      // ✅ handle upload via fetch
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(uploadForm);

        try {
          const res = await fetch("/api/files/upload", {
            method: "POST",
            body: formData,
          });
          const result = await res.json();

          if (res.ok) {
            window.location.reload(); // refresh after upload
          } else {
            alert(result.message || "Upload failed");
          }
        } catch (err) {
          console.error(err);
          alert("Something went wrong!");
        }
      });

      // ✅ handle logout via fetch
      logoutForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
          const res = await fetch("/api/users/logout", { method: "POST" });
          if (res.ok) {
            window.location.href = "/"; // redirect to login
          } else {
            alert("Logout failed");
          }
        } catch (err) {
          console.error(err);
          alert("Something went wrong!");
        }
      });
    </script>
  </body>
</html>
